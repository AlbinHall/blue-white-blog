{% extends 'base.html' %}
{% block content %}

<h2>Discussion: {{ discussion.title }}</h2>
<p>{{ discussion.description }}</p>
<h3>Comments:</h3>
<ul>
  {% for comment in comments %}
    <li>{{ comment.text }}</li>
    {% if comment.children.exists %}
      <ul>
        {% for child in comment.children.all %}
          <li>{{ child.text }}</li>
        {% endfor %}
      </ul>
    {% endif %}
    <form method="post">
      {% csrf_token %}
      {{ form.as_p }}
      <input type="hidden" name="parent_id" value="{{ comment.id }}">
      <button type="submit">Reply</button>
    </form>
  {% endfor %}
</ul>
</div>
<hr>
<h3>Add a Comment</h3>
<form method="post">
  {% csrf_token %}
  {{ form.as_p }}
  <button type="submit">Save</button>
</form>
<script>
  $(document).on("click", ".reply-button", function() {
    var commentId = $(this).data("comment-id");
    $(".reply-form[data-comment-id=" + commentId + "]").toggle();
  });

  $(document).on("submit", ".reply-form", function(event) {
    event.preventDefault();

    var form = $(this);
    var commentId = form.data("comment-id");
    var commentText = form.find("input[name=text]").val();

    // Send an AJAX request to the server to save the reply
    $.post("/save-reply/", { comment_id: commentId, text: commentText }, function(data) {
      // Add the reply to the list of child comments for the parent comment
      form.before("<div class='comment'>" + commentText + "</div>");
      form.toggle();
    });
  });
</script>
{% endblock %}